name: Cleanup Test Resources

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      pattern:
        description: 'Workspace name pattern to delete (e.g., "*Updated*")'
        required: false
        default: 'Updated Workspace Name*'
        type: string
  
  # Allow calling from other workflows
  workflow_call:
    inputs:
      pattern:
        description: 'Workspace name pattern to delete'
        required: false
        default: 'Updated Workspace Name*'
        type: string
    secrets:
      POSTMAN_API_KEY:
        required: true
  
  

jobs:
  cleanup-workspaces:
    name: Delete Test Workspaces
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Try to download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: functional-tests-coverage
          path: ./test-artifacts
        continue-on-error: true
      
      - name: Extract workspace ID from test-ids.json
        id: extract-workspace-id
        run: |
          if [ -f "./test-artifacts/src/__tests__/test-ids.json" ]; then
            echo "Found test-ids.json, extracting workspace ID..."
            WORKSPACE_ID=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('./test-artifacts/src/__tests__/test-ids.json', 'utf8'));
                console.log(data.workspace?.id || '');
              } catch (error) {
                console.error('Error parsing test-ids.json:', error.message);
              }
            ")
            if [ -n "$WORKSPACE_ID" ]; then
              echo "workspace_id=$WORKSPACE_ID" >> $GITHUB_OUTPUT
              echo "âœ“ Found workspace ID: $WORKSPACE_ID"
            else
              echo "workspace_id=" >> $GITHUB_OUTPUT
              echo "âš  No workspace ID found in test-ids.json"
            fi
          else
            echo "workspace_id=" >> $GITHUB_OUTPUT
            echo "â„¹ test-ids.json not found, will use pattern-based cleanup"
          fi
        continue-on-error: true
      
      - name: Delete test workspaces
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: |
          WORKSPACE_ID="${{ steps.extract-workspace-id.outputs.workspace_id }}"
          PATTERN="${{ inputs.pattern || 'Updated Workspace Name*' }}"
          
          if [ -n "$WORKSPACE_ID" ]; then
            echo "ðŸŽ¯ Deleting workspace by ID: $WORKSPACE_ID"
            node util/delete-test-workspaces.js --workspaceId="$WORKSPACE_ID" --force
          else
            echo "ðŸ” Deleting workspaces matching pattern: $PATTERN"
            node util/delete-test-workspaces.js "$PATTERN" --force
          fi
        continue-on-error: true
      
      - name: Cleanup Summary
        if: always()
        run: |
          echo "### ðŸ§¹ Test Resources Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          WORKSPACE_ID="${{ steps.extract-workspace-id.outputs.workspace_id }}"
          if [ -n "$WORKSPACE_ID" ]; then
            echo "**Method:** ID-based cleanup" >> $GITHUB_STEP_SUMMARY
            echo "**Workspace ID:** \`$WORKSPACE_ID\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Method:** Pattern-based cleanup" >> $GITHUB_STEP_SUMMARY
            echo "**Pattern:** \`${{ inputs.pattern || 'Updated Workspace Name*' }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test workspace cleanup has been executed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow deletes workspaces by ID (if available) or pattern." >> $GITHUB_STEP_SUMMARY
          echo "Failures are non-blocking - check logs for details." >> $GITHUB_STEP_SUMMARY


  summary:
    name: Cleanup Summary
    runs-on: ubuntu-latest
    needs: [cleanup-workspaces]
    if: always()
    
    steps:
      - name: Overall Summary
        run: |
          echo "### âœ… Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cleanup job status:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§¹ Workspaces: ${{ needs.cleanup-workspaces.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: All cleanup operations use 'continue-on-error: true'" >> $GITHUB_STEP_SUMMARY
          echo "and do not affect the overall workflow status." >> $GITHUB_STEP_SUMMARY


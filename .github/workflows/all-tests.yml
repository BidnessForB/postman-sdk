name: Postman SDK - All Tests
# run 'em all now dangit

on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests with coverage
    uses: ./.github/workflows/unit-tests.yml

  functional-tests:
    name: Functional Tests with coverage
    uses: ./.github/workflows/functional-tests.yml
    secrets: inherit

  cleanup:
    name: Cleanup Test Resources
    runs-on: ubuntu-latest
    needs: [functional-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run workspace cleanup
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: node util/delete-test-workspaces.js 'Updated Workspace Name*' --force
        continue-on-error: true
      
      - name: Cleanup Summary
        if: always()
        run: |
          echo "### ðŸ§¹ Cleanup Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test workspace cleanup has been executed." >> $GITHUB_STEP_SUMMARY
          echo "This step runs independently and does not affect pipeline status." >> $GITHUB_STEP_SUMMARY

  all-tests-status:
    name: Run unit and functional tests with coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, functional-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Functional Tests: ${{ needs.functional-tests.result }}"
          
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "âŒ Unit tests failed or were cancelled"
            exit 1
          fi
          
          if [ "${{ needs.functional-tests.result }}" != "success" ]; then
            echo "âŒ Functional tests failed or were cancelled"
            exit 1
          fi
          
          echo "âœ… All tests passed successfully!"
      
      - name: Summary
        if: success()
        run: |
          echo "### âœ… All Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both unit tests and functional tests completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Functional Tests: Passed" >> $GITHUB_STEP_SUMMARY
      
      - name: Summary (Failure)
        if: failure()
        run: |
          echo "### âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more test suites failed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Functional Tests: ${{ needs.functional-tests.result }}" >> $GITHUB_STEP_SUMMARY

